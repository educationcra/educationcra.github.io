<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRA Job Fair 2026 Analytics</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <style>
    body { font-family: 'Noto Sans Thai', sans-serif; background-color: #f1f5f9; }
    .metric-card { @apply bg-white p-6 rounded-3xl shadow-sm border border-slate-200 transition-all hover:shadow-md; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #0F2C67; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="text-slate-800 antialiased">

  <div id="loading" class="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
    <div class="loader mb-4"></div>
    <p class="text-blue-900 font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢...</p>
  </div>

  <div id="app" class="max-w-7xl mx-auto px-4 py-8 opacity-0 transition-opacity duration-700">
    <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
      <div class="text-center md:text-left">
        <h1 class="text-3xl font-black text-blue-900 tracking-tight">CRA JOB FAIR & EDUCATION 2026</h1>
        <p class="text-slate-500 font-medium">Analytics Dashboard (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 12-13 ‡∏Å.‡∏û.)</p>
      </div>
      
      <div class="bg-white p-2 rounded-2xl shadow-sm border flex items-center gap-3">
        <span class="text-xs font-bold text-slate-400 pl-3 uppercase">‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
        <select id="dateFilter" onchange="updateDashboard()" class="border-none font-bold text-blue-900 focus:ring-0 rounded-xl cursor-pointer">
          <option value="ALL">‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á 2 ‡∏ß‡∏±‡∏ô</option>
          <option value="12.02.69">12 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569</option>
          <option value="13.02.69">13 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569</option>
        </select>
        <button onclick="window.print()" class="bg-blue-900 text-white px-5 py-2 rounded-xl font-bold text-sm hover:bg-blue-800">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
      </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
      <div class="metric-card">
        <p class="text-slate-400 text-xs font-bold uppercase mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
        <div class="flex items-baseline gap-2">
          <span class="text-4xl font-black text-blue-900" id="totalCount">0</span>
          <span class="text-slate-400 font-bold">‡∏Ñ‡∏ô</span>
        </div>
      </div>
      <div class="metric-card bg-blue-900 text-white border-none">
        <p class="text-blue-200 text-xs font-bold uppercase mb-2">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à‡∏£‡∏ß‡∏° (T)</p>
        <div class="flex items-baseline gap-2">
          <span class="text-4xl font-black text-white" id="avgT">0.00</span>
          <span class="text-blue-300 font-bold">/ 5.00</span>
        </div>
      </div>
      <div class="metric-card">
        <p class="text-slate-400 text-xs font-bold uppercase mb-2">‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏£‡πà‡∏ß‡∏°‡∏õ‡∏µ‡∏´‡∏ô‡πâ‡∏≤ (U)</p>
        <div class="flex items-baseline gap-2">
          <span class="text-4xl font-black text-emerald-600" id="pctU">0</span>
          <span class="text-slate-400 font-bold">%</span>
        </div>
      </div>
      <div class="metric-card">
        <p class="text-slate-400 text-xs font-bold uppercase mb-2">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (P)</p>
        <div class="flex items-baseline gap-2">
          <span class="text-4xl font-black text-orange-600" id="avgP">0.00</span>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-3xl p-8 shadow-sm border mb-10">
      <h3 class="font-bold text-slate-700 mb-8 border-l-4 border-blue-900 pl-4">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡πÄ‡∏ï‡πá‡∏° 5)</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-10" id="scoreSections"></div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
      <div class="bg-white p-8 rounded-3xl shadow-sm border">
        <h3 class="font-bold text-slate-700 mb-6">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° (‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞)</h3>
        <div class="h-64"><canvas id="chartType"></canvas></div>
      </div>
      <div class="bg-white p-8 rounded-3xl shadow-sm border">
        <h3 class="font-bold text-slate-700 mb-6">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£ (W)</h3>
        <div id="tableW"></div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <div class="bg-white p-8 rounded-3xl shadow-sm border">
        <h3 class="font-bold text-blue-900 mb-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h3>
        <div id="tableCompany"></div>
      </div>
      <div class="bg-white p-8 rounded-3xl shadow-sm border">
        <h3 class="font-bold text-orange-600 mb-4">‡∏ö‡∏π‡∏ò‡∏™‡∏õ‡∏≠‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h3>
        <div id="tableSponsor"></div>
      </div>
    </div>

    <div class="mt-10 grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-slate-800 text-white rounded-3xl p-8">
            <h3 class="font-bold mb-4">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏õ‡∏µ‡∏´‡∏ô‡πâ‡∏≤ (AB, AG)</h3>
            <div id="listWanted" class="space-y-2 max-h-60 overflow-y-auto text-sm opacity-90 pr-2"></div>
        </div>
        <div class="bg-blue-50 border border-blue-100 rounded-3xl p-8">
            <h3 class="font-bold text-blue-900 mb-4">‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (AC, AH)</h3>
            <div id="listSuggest" class="space-y-2 max-h-60 overflow-y-auto text-sm pr-2"></div>
        </div>
    </div>
  </div>

  <script>
    Chart.register(ChartDataLabels);
    // *** ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô Web App URL ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ***
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbylyonLUKe_jJjbrtTASPg9Rphi7Ln9vRU2mO7Q6l-QcZ3p2htU_5NLUxIi2khhoa8s/exec';
    
    let ALL_DATA = [];
    let charts = {};

    window.onload = async () => {
      try {
        const response = await fetch(GAS_URL);
        const data = await response.json();
        if(data.error) throw new Error(data.error);
        ALL_DATA = data;
        updateDashboard();
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('app').classList.remove('opacity-0');
      } catch (err) {
        alert("üö® ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message + "\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Permission ‡πÄ‡∏õ‡πá‡∏ô 'Anyone' ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á");
      }
    };

    function updateDashboard() {
      const selectedDate = document.getElementById('dateFilter').value;
      const data = selectedDate === "ALL" ? ALL_DATA : ALL_DATA.filter(r => r[23].includes(selectedDate));
      const n = data.length;

      // 1. KPIs
      document.getElementById('totalCount').innerText = n.toLocaleString();
      document.getElementById('avgT').innerText = calcAvg(data, 19);
      document.getElementById('avgP').innerText = calcAvg(data, 15);
      
      const nextCount = data.filter(r => r[20].includes("‡∏™‡∏ô‡πÉ‡∏à")).length;
      document.getElementById('pctU').innerText = ((nextCount/n)*100 || 0).toFixed(1);

      // 2. Score Bars (Q, R, S)
      const metrics = [
        {idx: 16, label: '‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ (Q)'},
        {idx: 17, label: '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (R)'},
        {idx: 18, label: '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ö‡∏ô‡πÄ‡∏ß‡∏ó‡∏µ (S)'}
      ];
      document.getElementById('scoreSections').innerHTML = metrics.map(m => {
        const avg = calcAvg(data, m.idx);
        const pct = (avg/5*100).toFixed(0);
        return `<div>
          <div class="flex justify-between mb-2 text-sm font-bold"><span class="text-slate-500">${m.label}</span><span class="text-blue-900">${avg}</span></div>
          <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden">
            <div class="bg-blue-900 h-full" style="width:${pct}%"></div>
          </div>
        </div>`;
      }).join('');

      // 3. Charts
      renderBarChart('chartType', getCounts(data, 2), n);

      // 4. Tables with ‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞
      renderTable('tableW', getCounts(data, 22, true), n, ['‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á', '‡∏Ñ‡∏ô', '‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞']);
      renderTable('tableCompany', getCombinedCounts(data, [24, 25, 29, 30]), n, ['‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó', '‡∏Ñ‡∏ô‡∏™‡∏ô‡πÉ‡∏à', '‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞'], 10);
      renderTable('tableSponsor', getCombinedCounts(data, [26, 31]), n, ['‡∏ö‡∏π‡∏ò', '‡πÇ‡∏´‡∏ß‡∏ï', '‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞'], 5);

      // 5. Lists
      renderTextList('listWanted', data, [27, 32]);
      renderTextList('listSuggest', data, [28, 33]);
    }

    // --- Helper Functions ---
    function calcAvg(data, idx) {
      const vals = data.map(r => parseFloat(r[idx])).filter(v => !isNaN(v));
      return vals.length ? (vals.reduce((a,b)=>a+b, 0)/vals.length).toFixed(2) : "0.00";
    }

    function getCounts(data, idx, isMulti = false) {
      let c = {};
      data.forEach(r => {
        let items = isMulti ? (r[idx]||"").split(/,\s*/) : [r[idx]];
        items.forEach(it => { if(it && it.trim() !== "" && it !== "-") c[it.trim()] = (c[it.trim()]||0)+1; });
      });
      return Object.entries(c).sort((a,b) => b[1]-a[1]);
    }

    function getCombinedCounts(data, indices) {
      let c = {};
      data.forEach(r => indices.forEach(idx => {
        let v = r[idx]?.trim();
        if(v && v !== "" && v !== "-") c[v] = (c[v]||0)+1;
      }));
      return Object.entries(c).sort((a,b) => b[1]-a[1]);
    }

    function renderTable(id, counts, total, headers, limit = 99) {
      document.getElementById(id).innerHTML = `
        <table class="w-full text-sm">
          <thead><tr class="text-slate-400 border-b"><th class="py-2 text-left">${headers[0]}</th><th class="text-right">${headers[1]}</th><th class="text-right">${headers[2]}</th></tr></thead>
          <tbody>${counts.slice(0,limit).map(it => `
            <tr class="border-b"><td class="py-2">${it[0]}</td><td class="text-right font-bold text-blue-900">${it[1]}</td><td class="text-right text-slate-400">${((it[1]/total)*100).toFixed(1)}%</td></tr>
          `).join('')}</tbody>
        </table>`;
    }

    function renderTextList(id, data, indices) {
      let list = [];
      data.forEach(r => indices.forEach(idx => { if(r[idx] && r[idx].length > 2) list.push(r[idx]); }));
      document.getElementById(id).innerHTML = list.length ? list.map(t => `<div class="bg-white/10 p-2 rounded mb-1">‚ñ™Ô∏è ${t}</div>`).join('') : "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
    }

    function renderBarChart(id, counts, total) {
      if(charts[id]) charts[id].destroy();
      charts[id] = new Chart(document.getElementById(id), {
        type: 'bar',
        data: { labels: counts.map(c=>c[0]), datasets: [{ data: counts.map(c=>c[1]), backgroundColor: '#0F2C67' }] },
        options: { 
          maintainAspectRatio: false, indexAxis: 'y',
          plugins: { 
            legend: { display: false },
            datalabels: { color: '#64748b', anchor: 'end', align: 'right', formatter: (v) => `${((v/total)*100).toFixed(1)}%` }
          },
          scales: { x: { display: false }, y: { grid: { display: false } } }
        }
      });
    }
  </script>
</body>
</html>
