<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRA Job Fair 2026 Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans Thai', sans-serif; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #0F2C67; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-slate-50 antialiased">

  <div id="loading" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
    <div class="loader mb-4"></div>
    <p class="text-blue-900 font-bold">กำลังเชื่อมต่อฐานข้อมูล CRA 2026...</p>
  </div>

  <div id="app" class="container mx-auto p-4 opacity-0 transition-opacity duration-500">
    <header class="flex justify-between items-center mb-6 border-b pb-4">
      <h1 class="text-2xl font-bold text-blue-900">CRA Job Fair & Education 2026</h1>
      <button onclick="window.print()" class="bg-blue-900 text-white px-4 py-2 rounded-lg text-sm">พิมพ์รายงาน</button>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-blue-100">
        <p class="text-gray-500 text-sm">ผู้ตอบแบบประเมินทั้งหมด</p>
        <p class="text-4xl font-bold text-blue-900" id="totalCount">0</p>
      </div>
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-orange-100 col-span-2">
        <p class="text-gray-500 text-sm mb-2">เฉลี่ยความพึงพอใจภาพรวม (เต็ม 5)</p>
        <div class="flex items-center gap-4">
            <p class="text-4xl font-bold text-orange-600" id="avgScore">0.00</p>
            <div class="flex-1 bg-gray-200 h-3 rounded-full overflow-hidden">
                <div id="scoreBar" class="bg-orange-500 h-full w-0 transition-all duration-1000"></div>
            </div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <div class="bg-white p-6 rounded-2xl shadow-sm border h-80"><canvas id="genderChart"></canvas></div>
      <div class="bg-white p-6 rounded-2xl shadow-sm border h-80"><canvas id="typeChart"></canvas></div>
    </div>

    <div class="bg-white p-6 rounded-2xl shadow-sm border">
      <h3 class="font-bold text-blue-900 mb-4">10 อันดับสถานประกอบการที่ได้รับความสนใจสูงสุด</h3>
      <table class="w-full text-left text-sm">
        <thead><tr class="bg-gray-50 text-gray-600 font-bold"><th class="p-2">อันดับ</th><th>บริษัท</th><th class="text-right p-2">จำนวนผู้สนใจ</th></tr></thead>
        <tbody id="companyBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    // ** เปลี่ยน URL ตรงนี้เป็นตัวใหม่ที่ได้จากการ Deploy ครั้งล่าสุด **
    const API_URL = 'https://script.google.com/macros/s/AKfycbylyonLUKe_jJjbrtTASPg9Rphi7Ln9vRU2mO7Q6l-QcZ3p2htU_5NLUxIi2khhoa8s/exec?type=json';

    async function loadData() {
      try {
        const response = await fetch(API_URL);
        if (!response.ok) throw new Error('Network response was not ok');
        const data = await response.json();
        
        if (data.error) throw new Error(data.error);
        
        processDashboard(data);
        
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('app').classList.remove('opacity-0');
      } catch (err) {
        console.error(err);
        alert("⚠️ " + err.message + "\n\nคำแนะนำ: ตรวจสอบว่าใน Code.gs ตั้งค่าเป็น 'Anyone' แล้วหรือยัง?");
      }
    }

    function processDashboard(data) {
      document.getElementById('totalCount').innerText = data.length.toLocaleString();

      // 1. คะแนนความพึงพอใจภาพรวม (คอลัมน์ T คือ Index 19)
      const scores = data.map(r => parseFloat(r[19])).filter(s => !isNaN(s));
      const avg = scores.length ? (scores.reduce((a,b)=>a+b, 0)/scores.length).toFixed(2) : 0;
      document.getElementById('avgScore').innerText = avg;
      document.getElementById('scoreBar').style.width = (avg/5*100) + '%';

      // 2. ข้อมูลแผนภูมิ: เพศ(Index 1), ประเภท(Index 2)
      createChart('genderChart', 'doughnut', 'เพศ', getCounts(data, 1));
      createChart('typeChart', 'bar', 'ประเภทผู้เข้าร่วม', getCounts(data, 2));

      // 3. อันดับบริษัท: รวม Y(24), Z(25), AD(29), AE(30)
      let companies = {};
      data.forEach(r => {
        [24, 25, 29, 30].forEach(idx => {
          let name = r[idx]?.trim();
          if(name && name !== "-" && name !== "") companies[name] = (companies[name] || 0) + 1;
        });
      });
      const topComps = Object.entries(companies).sort((a,b) => b[1]-a[1]).slice(0, 10);
      document.getElementById('companyBody').innerHTML = topComps.map((c, i) => `
        <tr class="border-t">
          <td class="p-2">${i+1}</td>
          <td>${c[0]}</td>
          <td class="text-right p-2 font-bold text-blue-900">${c[1]}</td>
        </tr>
      `).join('');
    }

    function getCounts(data, idx) {
      let counts = {};
      data.forEach(r => { let v = r[idx]?.trim() || "ไม่ระบุ"; counts[v] = (counts[v] || 0) + 1; });
      return Object.entries(counts).sort((a,b) => b[1]-a[1]);
    }

    function createChart(id, type, label, counts) {
      new Chart(document.getElementById(id), {
        type: type,
        data: {
          labels: counts.map(c => c[0]),
          datasets: [{ label: label, data: counts.map(c => c[1]), backgroundColor: ['#0F2C67','#E65100','#3b82f6','#10b981','#f59e0b'] }]
        },
        options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
      });
    }

    loadData();
  </script>
</body>
</html>
